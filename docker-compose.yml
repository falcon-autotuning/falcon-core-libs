
services:
  dev:
    image: archlinux:latest
    container_name: falcon-arch-dev
    tty: true
    stdin_open: true
    environment:
      # forwarded from host; compose will substitute ${SSH_AUTH_SOCK} at runtime
      - SSH_AUTH_SOCK=/ssh-agent
      - REPO=falcon-autotuning/falcon-core
      - RELEASE_TAG=v0.0.1
      - GH_TOKEN=${GH_TOKEN}
    volumes:
      - .:/workdir:rw,z
      - falcon-arch-ccache:/home/builduser/.ccache
      - ${SSH_AUTH_SOCK}:/ssh-agent:z
      - ~/.ssh:/home/builduser/.ssh:ro,z
      - ./docker-entrypoint.sh:/docker-entrypoint.sh:ro,z
    working_dir: /workdir
    entrypoint: ["/bin/bash", "-lc", "if ! getent passwd builduser >/dev/null 2>&1; then useradd -m builduser; fi; bash /docker-entrypoint.sh"]

volumes:
  falcon-arch-ccache:
