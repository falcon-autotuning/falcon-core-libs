name: Go Windows CI

on:
  workflow_call:
  workflow_dispatch:
  push:
    branches: [dev]

jobs:
  build-and-test:
    name: Build and Test Go (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install falcon-core dependencies (Git Bash)
        shell: bash
        run: |
          echo "=== Installing falcon-core package ==="
          # Makefile detects Windows and downloads Windows packages
          make install

          echo "✓ falcon-core installed successfully"

      - name: Verify falcon-core installation (Git Bash)
        shell: bash
        run: |
          echo "=== Verifying installation ==="
          ls -la "$USERPROFILE/AppData/Local/falcon/lib/" || echo "Lib directory check"
          ls -la "$USERPROFILE/AppData/Local/falcon/include/falcon-core-c-api/" || echo "Include directory check"
          ls -la "$USERPROFILE/AppData/Local/falcon/lib/pkgconfig/" || echo "Pkgconfig directory check"
          echo "✓ Installation verified"

      - name: Set CGO environment variables (PowerShell)
        shell: pwsh
        run: |
          Write-Host "=== Setting CGO environment variables ===" -ForegroundColor Cyan

          $falconBase = "$env:USERPROFILE\AppData\Local\falcon"
          $falconLib = "$falconBase\lib"
          $falconInclude = "$falconBase\include"

          # Set CGO flags for compilation and linking
          $cgoLdflags = "-L$falconLib -lfalcon_core_c_api -lfalcon_core_cpp"
          $cgoCflags = "-I$falconInclude/falcon-core-c-api -I$falconInclude/falcon-core-cpp"
          $pkgConfigPath = "$falconLib\pkgconfig"

          Write-Host "CGO_LDFLAGS: $cgoLdflags"
          Write-Host "CGO_CFLAGS: $cgoCflags"
          Write-Host "PKG_CONFIG_PATH: $pkgConfigPath"

          # Add to GitHub Actions environment
          echo "CGO_LDFLAGS=$cgoLdflags" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "CGO_CFLAGS=$cgoCflags" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "PKG_CONFIG_PATH=$pkgConfigPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          # Add falcon lib to PATH for DLL resolution
          echo "$falconLib" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

          Write-Host "✓ Environment variables set" -ForegroundColor Green

      - name: Verify environment variables (PowerShell)
        shell: pwsh
        run: |
          Write-Host "=== Verifying environment ===" -ForegroundColor Cyan
          Write-Host "CGO_LDFLAGS: $env:CGO_LDFLAGS"
          Write-Host "CGO_CFLAGS: $env:CGO_CFLAGS"
          Write-Host "PKG_CONFIG_PATH: $env:PKG_CONFIG_PATH"
          Write-Host "PATH includes:" (($env:PATH -split ';') | Select-String -Pattern 'falcon')

      - name: Build Go packages (PowerShell)
        working-directory: go/falcon-core
        shell: pwsh
        run: |
          Write-Host "=== Building Go packages ===" -ForegroundColor Cyan

          # Verify environment is set
          Write-Host "CGO_LDFLAGS: $env:CGO_LDFLAGS"
          Write-Host "CGO_CFLAGS: $env:CGO_CFLAGS"

          go build ./...

          if ($LASTEXITCODE -ne 0) {
            Write-Error "ERROR: Build failed!"
            exit $LASTEXITCODE
          }

          Write-Host "✓ Build successful" -ForegroundColor Green

      - name: Run Go tests (PowerShell)
        working-directory: go/falcon-core
        shell: pwsh
        run: |
          Write-Host "=== Running Go tests ===" -ForegroundColor Cyan

          go test ./...

          if ($LASTEXITCODE -ne 0) {
            Write-Error "ERROR: Tests failed!"
            exit $LASTEXITCODE
          }

          Write-Host "✓ All tests passed" -ForegroundColor Green

      - name: Verify build artifacts (PowerShell)
        working-directory: go/falcon-core
        shell: pwsh
        run: |
          Write-Host "=== Verifying Go build ===" -ForegroundColor Cyan
          go list ./...
          Write-Host "✓ Build verification complete" -ForegroundColor Green
